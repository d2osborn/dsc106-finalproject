<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Effect of 2 Strikes on a Hitter's Swing</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="module" src="story graphs/vis.js"></script>
    <script type="module" src="story graphs/contactscatter.js"></script>
    <script type="module" src="story graphs/radar.js"></script>
    <script type="module" src="story graphs/yordanstats.js"></script>
    <script type="module" src="story graphs/overall.js"></script>

    <!-- Import the 3D animation script -->
    <script type="module" src="./graphs/swingAnimationWithOBJ.js"></script>

    <script type="module">
        import { drawAttackAngle } from './graphs/attackAngle.js';
        import { drawBatSpeed } from './graphs/batSpeed.js';
        import { drawSwingPathTilt } from './graphs/swingPathTilt.js';
        import { drawDirectionAngle } from './graphs/directionAngle.js';

        window.addEventListener('DOMContentLoaded', () => {
            // Load deltaHists.js after DOM is ready
            const deltaHistsScript = document.createElement('script');
            deltaHistsScript.type = 'module';
            deltaHistsScript.src = 'story graphs/deltaHists.js';
            document.head.appendChild(deltaHistsScript);

            const controls = d3.select('.sandbox-controls');
            controls.html(`
                <div style="display:flex;align-items:center;gap:1em;">
                    <label style="color:#fff;font-weight:bold;">Player:
                        <input id="player-input" list="player-list" placeholder="e.g. Shohei Ohtani" autocomplete="off"
                               style="padding:0.4em 0.8em;font-size:1em;">
                        <datalist id="player-list"></datalist>
                    </label>
                    <label style="color:#fff;font-weight:bold;">Strikes:
                        <label><input type="radio" name="count" value="0" checked> 0 Strikes</label>
                        <label style="margin-left:10px;"><input type="radio" name="count" value="2"> 2 Strikes</label>
                    </label>
                </div>
            `);

            const inputElem = document.getElementById('player-input');
            const dataList = document.getElementById('player-list');
            const radios = Array.from(document.getElementsByName('count'));

            // Load JSONs
            Promise.all([
                d3.json('files/sandbox/players_angles_0str.json'),
                d3.json('files/sandbox/players_angles_2str.json'),
                d3.json('files/sandbox/zerostr_stats.json'),
                d3.json('files/sandbox/twostr_stats.json')
            ]).then(([players0, players2, zeroStats, twoStats]) => {
                // Build lookups
                const playerLookup = { '0': players0, '2': players2 };
                const leagueLookup = { '0': zeroStats[0], '2': twoStats[0] };

                // Autocomplete list from 0-strike players
                const players = players0.map(d => d.name_with_stand).sort();
                function populateList(filter = '') {
                    const opts = filter
                        ? players.filter(p => p.toLowerCase().includes(filter.toLowerCase())).slice(0, 10)
                        : [];
                    dataList.innerHTML = opts.map(p => `<option value="${p}">`).join('');
                }
                inputElem.addEventListener('input', () => populateList(inputElem.value));

                function getSelectedCount() {
                    return radios.find(r => r.checked).value;
                }

                function update() {
                    const count = getSelectedCount();
                    const playerName = inputElem.value.trim();

                    // Attempt to find player stats
                    const playerEntry = playerLookup[count].find(d => d.name_with_stand === playerName);

                    // Prepare drawData: single object array
                    const drawObj = playerEntry
                        ? playerEntry
                        : Object.assign({ name_with_stand: 'League Average' }, leagueLookup[count]);
                    const drawData = [drawObj];

                    console.log('Drawing with data:', drawObj); // Debug log

                    // Clear previous
                    d3.selectAll('.sandbox-viz').html('');

                    // Draw
                    drawAttackAngle(d3.select('#zone-map'), drawData, { title: 'Attack Angle (°)', max: 60 });
                    drawBatSpeed(d3.select('#outcome-scatter'), drawData, { title: 'Bat Speed (mph)', max: 120 });
                    drawSwingPathTilt(d3.select('#direction-angle-plot'), drawData, { title: 'Swing Path Tilt (°)', max: 60 });
                    drawDirectionAngle(d3.select('#attack-angle-plot'), drawData, { title: 'Direction Angle (°)', max: 60 });

                    // 3D updates
                    if (window.updateAttackAngleVisualization) {
                        window.updateAttackAngleVisualization(drawObj.attack_angle);
                    }
                    if (window.updateDirectionAngleVisualization) {
                        window.updateDirectionAngleVisualization(drawObj.attack_direction);
                    }
                    if (window.updateSwingPathTilt) {
                        window.updateSwingPathTilt(drawObj.swing_path_tilt);
                    }
                }

                // Event listeners
                radios.forEach(r => r.addEventListener('change', update));
                inputElem.addEventListener('change', update);
                inputElem.addEventListener('keyup', e => { if (e.key === 'Enter') update(); });

                // Initial
                populateList();
                update();
            }).catch(err => console.error('Error loading JSON:', err));
        });
    </script>
    <style>
        #stats, #overall-graph, #scatter-contact-woba, #radarChart, #heatmap0, #heatmap2, #delta-hists, #correlation-graphs, .correlation-graph {
            background: transparent;
            border: none;
            box-shadow: none !important;
        }
        
        .card-circle {
            fill: transparent;
            stroke: #002D62;
            stroke-width: 2;
        }
        
        .circle-value, .circle-actual {
            fill: #002D62;
        }
        
        .circle-value.highlight {
            fill: #DC143C;
        }

        #scatter-contact-woba svg, #radarChart svg, #heatmap0 svg, #heatmap2 svg, #delta-hists svg, .correlation-graph svg {
            background: transparent;
            box-shadow: none !important;
        }

        .radar-container, .heatmap, .hist-container {
            background: transparent;
            border: none;
            box-shadow: none !important;
        }

        /* Make histogram wider */
        #delta-hists {
            width: 120%;
            margin-left: -10%;
        }

        .hist-container {
            width: 100%;
            background: transparent !important;
            box-shadow: none !important;
        }

        .heatmap {
            background: transparent !important;
            box-shadow: none !important;
        }

        /* Remove shadow from stats container */
        #stats {
            box-shadow: none !important;
            background: transparent !important;
        }

        /* Remove shadow from radar container */
        .radar-section {
            box-shadow: none !important;
            background: transparent !important;
        }

        .radar-container {
            box-shadow: none !important;
            background: transparent !important;
        }

        /* Correlation section styles */
        #correlation-section {
            background: transparent !important;
            box-shadow: none !important;
        }

        .correlation-graph {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }

        .correlation-graph .title {
            color: #EB6E1F !important;
        }
    </style>
</head>
<body>
    <h1 class="main-title" id="dynamic-title"></h1>

    <div class="video-effect-container">
        <canvas id="effect-canvas"></canvas>
        <video id="source-video" src="images/yordan.mp4" preload="auto" crossorigin="anonymous" style="display:none;" muted autoplay loop></video>
        
        <div class="scroll-arrows" onclick="scrollPastVideo()">&#x276F;&#x276F;&#x276F;</div>
    </div>
    <!-- COMBINED STATS/INTRO/CHART CONTAINER -->
    <section class="section-container">
        <div class="intro">
            <p>
                Yordan Alvarez is an outfielder/designated hitter for the Houston Astros.
                In 2024, he was voted an All-Star starter at the DH spot and an All-Star
                for his third consecutive year and finished top 10 in AL MVP voting.<br>
                Yordan's 2024 overall statistics speak for themselves: 
                His weighted on-base average (wOBA) was 96th percentile among MLB hitters.
                Yordan Alvarez stands out in particularly tough situations with two strikes.
                Let's investigate what made him a consistent top performer in different counts.
            </p>
        </div>
    </section>

    <!-- CHART CONTAINER ONLY: side-by-side layout -->
    <div id="chart-stats-container">
    <div id="stats"></div>
    <div id="overall-graph" class="chart"></div>
    <div id="tooltip"></div>
    </div>
    
    <section class="section-container">
        <div class="graph-section">
            <div class="heatmap-row">
                <div class="plot-text">
                    <h3 style="color: #EB6E1F;">2 Strike Contact% vs wOBA</h3>
                    <p>
                    At 2 strikes, it's common knowledge that hitters are taught to use a "B swing". <br>
                    Batters tend to focus more on making contact to survive or to get on the base instead of trying to slug the ball. <br>
                    However, that leads to them losing quality of hits; Making two-strike contact rate and wOBA a contradicting pair.  <br>
                    Yordan Alverz's statistics prove that he did not sacrifice hie quality of swings for contact. <br>
                    What is he doing differently?
                    </p>
                </div>
                <div id="scatter-contact-woba" class="chart"></div>
            </div>
        </div>
        <!-- Radar Chart Section -->
        <div class="graph-section">
            <div class="heatmap-row">
                <div id="radarChart"></div>
                <div class="plot-text">
                    <h3 style="color: #EB6E1F;">Yordan's 2-Strike Profile</h3>
                    <p>
                    Yordan Alvarez, compared to other MLB hitters, has noticeable top-notch attributes.
                    A couple of things to focus on in this radar graph are the chase and oppo rates.
                    The oppo rate represents his ability to hit to the opposite field, while the chase rate shows how often he expands his zone to make contact.
                    This analysis can be highlighted more in the density graph.
                    </p>
                </div>
            </div>
        </div>
        <!-- <div class="radar-section">
            <div class="radar-text">
                <h3 style="color: #EB6E1F;">Yordan's 2-Strike Profile</h3>
                <p>
                    Yordan Alvarez, compared to other MLB hitters, has noticeable top-notch attributes.
                    A couple of things to focus on in this radar graph are the chase and oppo rates.
                    The oppo rate represents his ability to hit to the opposite field, while the chase rate shows how often he expands his zone to make contact.
                    This analysis can be highlighted more in the density graph.
                </p>
            </div>
            <div class="radar-container">
                <div id="radarChart"></div>
            </div>
        </div> -->

        <!-- Attack Angle Section -->


        <!-- Contact Zone Section -->
        <div class="graph-section">
            <div class="heatmap-row">
                <div class="plot-text">
                    <h3 style="color: #EB6E1F;">Contact% Between Counts</h3>
                    <p>
                        As we can see from the side-by-side strike zone heatmaps, Yordan's contact% changes drastically from 0-strike counts to 2-strike counts. 
                        We can see how in 0-strike counts, he prefers to make contact more inside and along the middle of the zone, but in 2-strike counts, he expands his zone and even tends to make contact away.
                        This not only tells us that Yordan is willing to adjust his approach, but also that he can maintain quality contact even when expanding his zone.
                    </p>
                </div>
                <div class="plot-pair">
                    <div id="heatmap0" class="heatmap" style="margin-top: 5rem;"></div>
                    <div id="heatmap2" class="heatmap" style="margin-top: 5rem;"></div>
                </div>
            </div>
        </div>
        <h3 style="color: #EB6E1F;">Changes in Swing Metrics</h3>
        <p>
        For further analysis, we can encorporate Baseball Savant recently released new swing metrics: attack angle (º), attack direction (º), and swing path (tilt) (º)<br>
        These new metrics allow the public to take a deeper dive into swing geometry and better understand how hitters approach each at-bat. 
        Their swing geometry can dramatically affect batted-ball outcomes like wOBA, contact%, and groundball%.
        </p>
        <!-- Delta Histograms Section -->
        <div class="graph-section">
            <div class="heatmap-row">
                <div class="plot-text">
                    <p>
                    The histograms show how much MLB hitters swing metrics change in variance between 0-strike and 2-strike counts.
                    The distribution of attack angle changes between 0-strike and 2-strike counts reveals how hitters adjust their swing plane.
                    Yordan Alvarez shows a significant shift in variance of his attack angle, acheiving 96th percentile among MLB hitters.
                    This adjustment helps him maintain contact while sacrificing some power potential.
                    Each graph represents a different aspect of his swing: attack angle, attack direction, and swing path tilt.
                    The red line indicates Yordan's position relative to other MLB hitters, showing how his adjustments compare to the league average.
                    Click through the graphs to explore each metric in detail.
                    </p>
                </div>
                <div class="plot-pair" style="margin-left: auto; margin-right: 0;">
                    <div id="delta-hists" style="margin-left: auto;"></div>
                </div>
            </div>
        </div>


        <p class = "But">
        This result could mean that although he is changing his tilt of his upper body but the angle that his arms and his body makes remain consistent.
        Do the data reveal major leaguers follow Yordan's approach?<br><br>
        Here's change in variance scatter plot for the each metrics against important outcome rates.
        Explore league-wide trend and see how Yordan Alverez's appraoch can be justified.
        You can also dive deeper into player specific data down in the sandbox.
        </p>

      </section>

    <!-- Correlation Section -->
    <div id="correlation-section"></div>

    <!-- SANDBOX SECTION -->
    <section class="sandbox-section">
        <h2 class="sandbox-title">Explore How MLB Hitters Adjust in Two Strike Counts</h2>
        
        <!-- Controls -->
        <div class="sandbox-controls">
            <div style="display:flex;align-items:center;gap:1em;">
                <label style="color:#fff;font-weight:bold;">Player:
                    <input id="player-input" list="player-list" placeholder="e.g., Shohei Ohtani" autocomplete="off"
                           style="padding:0.4em 0.8em;font-size:1em;">
                    <datalist id="player-list"></datalist>
                </label>
                <label style="color:#fff;font-weight:bold;">Strikes:
                    <label><input type="radio" name="count" value="0" checked> 0 Strikes</label>
                    <label style="margin-left:10px;"><input type="radio" name="count" value="2"> 2 Strikes</label>
                </label>
            </div>
        </div>

        <!-- Dashboard Layout -->
        <div class="sandbox-layout">
            <!-- Left side: Blue rectangle -->
            <div class="small-rectangle"></div>

            <!-- Middle: 3D model container -->
            <div class="animation-container">
                <div id="animation-swing"></div>
            </div>

            <!-- Right side: 2x2 grid of squares -->
            <div class="graphs-container">
                <div id="zone-map" class="sandbox-viz"></div>
                <div id="outcome-scatter" class="sandbox-viz"></div>
                <div id="attack-angle-plot" class="sandbox-viz"></div>
                <div id="direction-angle-plot" class="sandbox-viz"></div>
            </div>
        </div>
    </section>
    <section>
        <div class="heatmap-row">
            <div class="plot-text">
              <h3>Conclusion</h3>
            <p class="Therefore">
                There seemed to be no textbook answer for swing adjustment at tough situations. 
                However, these new metrics brought us more clear idea there are combinations of change in approach that players can benefit from.
                The players with this knowledge can develop their unique swing geometry change.
                The mangers and coaches can also get analytical views on their players' approach to build sounder line up.
                These metrics, even though very insightful, should be taken into considerations of other components such as height, weight, ability to track the ball, bat speed, pressure, mentality.
                Therefore, it would be more comprehensive for further research that could encompass the other compounding factors. 
            </p>
        </div>
    </div>
    </section>

    <script type="module" src="vis/heatmap.js"></script>
    <script type="module" src="story graphs/leagueCorrelation.js"></script>
    <script type="module" src="graphs/statsTable.js"></script>

    <script>
        const titleWords = [
            ["The  ", "Effect"],
            ["of"],
            ["2  ", "Strikes"],
            ["on", "a"],
            ["Hitter's  ", "Swing"]
        ];

        const highlightWords = new Set(["THE  ", "EFFECT", "2  ", "STRIKES", "HITTER'S  ", "SWING"]);
        const specialColors = {
            "2  ": "#ffffff",
            "STRIKES": "#ffffff",
            "EFFECT": "#ffffff"
        };

        let html = "";
        for (let line of titleWords) {
            html += `<div style="margin-bottom: 0.4vw;">`;
            for (let word of line) {
                const wordUpper = word.toUpperCase();
                const fontSize = highlightWords.has(wordUpper) ? "4vw" : "1.5vw";
                const color = specialColors[wordUpper] || "#ffffff";
                html += `<span style="color:${color}; opacity:0.95; font-size:${fontSize}; margin-right: 0.4vw;">${wordUpper}</span>`;
            }
            html += `</div>`;
        }
        document.getElementById("dynamic-title").innerHTML = html.trim();

    
    
        // Video effect
        const video = document.getElementById('source-video');
        const canvas = document.getElementById('effect-canvas');
        const ctx = canvas.getContext('2d');
    
        function resizeCanvas() {
            const container = document.querySelector('.video-effect-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    
        function drawVideo() {
            if (video.readyState >= 2) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }
            requestAnimationFrame(drawVideo);
        }
        video.addEventListener('canplay', () => {
            video.playbackRate = 1.25;
            video.play();
            drawVideo();
        });
    
        // Scroll past the video when arrows are clicked
        function scrollPastVideo() {
            const videoContainer = document.querySelector('.video-effect-container');
            window.scrollTo({
                top: videoContainer.offsetHeight,
                behavior: 'smooth'
            });
        }
    </script>
</body>
</html>